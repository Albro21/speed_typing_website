{% extends 'base.html' %}
{% load static %}

{% block styles %}
	<style>
		body {
			min-height: 100vh;
			display: flex;
			flex-direction: column;
		}
		#main-content {
			flex-grow: 1;
			display: flex;
			flex-direction: column;
			justify-content: center;
		}
		.progress-circle {
			transform: rotate(0deg);
		}

		.progress-bg {
			stroke: var(--secondary);
		}

		.progress-bar {
			transition: stroke-dashoffset 0.7s ease;
			stroke: var(--primary);
		}
	</style>
{% endblock styles %}

{% block content %}
	<div class="d-flex flex-column gap-3 mt-2">

		<div class="row m-0">
			<!-- Level card -->
			<div class="col-3 px-2">
				<div class="card d-flex flex-column p-3">
					<h2 class="mb-1">{{ request.user.level.title }}</h2>
					<p class="mb-1">{{ request.user.level.description }}</p>
					<div class="d-flex flex-column">
						<div class="progress" role="progressbar" aria-label="Example with label" aria-valuenow="{{ request.user.exp }}" aria-valuemin="0" aria-valuemax="{{ request.user.level.exp_to_next }}" style="height: 25px">
							<div class="progress-bar" style="width: {{ request.user.exp_progress }}%"></div>
						</div>
						<div style="white-space: nowrap">
							{{ request.user.exp }} exp / {{ request.user.level.exp_to_next }} exp
						</div>
					</div>
				</div>
			</div>

			<div class="col-9 px-2 d-flex gap-3">
				
				<!-- Daily Goal -->
				<div class="card d-flex flex-column justify-content-center align-items-center h-100 p-3" id="daily-goal">
					<i class="bi bi-gear corner-icon fs-5 pointer" id="dailyGoalPopover" tabindex="0" data-bs-toggle="popover" data-bs-trigger="manual" title="Daily Goal"></i>
					<div id="popover-daily-goal" class="d-none">
						<form method="post" id="daily-goal-form" class="d-flex align-items-center gap-2 flex-nowrap custom-popover-form">
							{% csrf_token %}
							<label class="form-label mb-0">I want to practice for</label>
							<select name="daily_goal" class="form-select form-select-sm w-auto">
								{% for value, label in request.user.DAILY_GOAL_CHOICES %}
									<option value="{{ value }}" {% if request.user.daily_goal == value %}selected{% endif %}>{{ label|slice:":-3" }}</option>
								{% endfor %}
							</select>
							<span class="text-nowrap">minutes a day.</span>
						</form>
					</div>
					
					<svg class="progress-circle" width="120" height="120" viewBox="0 0 120 120">
						<circle
							class="progress-bg"
							cx="60" cy="60" r="54"
							stroke-width="12"
							fill="none"
							stroke="#262626"
						/>
						<circle
							class="progress-bar"
							cx="60" cy="60" r="54"
							stroke-width="12"
							fill="none"
							stroke="#e5e5e5"
							stroke-linecap="round"
							stroke-dasharray="339.292"
							stroke-dashoffset="{{ request.user.daily_goal_progress }}"
							transform="rotate(-90 60 60)"
						/>
						<text
							x="60" y="60"
							text-anchor="middle"
							fill="var(--foreground)"
							font-size="26"
							font-family="Arial, sans-serif"
						>{{ request.user.today_total_time_formatted }}</text>
						<text
							x="60" y="80"
							text-anchor="middle"
							fill="var(--secondary-foreground)"
							font-size="14"
							font-family="Arial, sans-serif"
						>/ {{ request.user.get_daily_goal_display }}</text>
					</svg>
				</div>
	
				<!-- Achievements -->
				<div class="card d-flex flex-row overflow-auto gap-2 flex-grow-1 align-items-center p-3">
					{% for achievement in achievements %}
						<img src="{{ achievement.icon.url }}" alt="{{ achievement.name }}" style="height: 120px; aspect-ratio: 1 / 1; object-fit: cover;">
					{% endfor %}
				</div>
			</div>
		</div>

		<!-- Statistics -->
		<div class="row mx-0">
			<!-- AVG Speed -->
			<div class="col px-2">
				<div class="card d-flex flex-row gap-2 align-items-center py-2 px-3 h-100">
					<img src="{% static 'img/speed.svg' %}" width="40px" height="40px">
					<div class="d-flex flex-column">
						<h6 class="m-0">AVG. Speed</h6>
						<p class="m-0">{{ request.user.avg_wpm }} WPM</p>
					</div>
				</div>
			</div>
			
			<!-- AVG Accuracy -->
			<div class="col px-2">
				<div class="card d-flex flex-row gap-2 align-items-center py-2 px-3 h-100">
					<img src="{% static 'img/accuracy.svg' %}" width="50px" height="50px">
					<div class="d-flex flex-column">
						<h6 class="m-0">AVG. Accuracy</h6>
						<p class="m-0">{{ request.user.avg_accuracy }}%</p>
					</div>
				</div>
			</div>
			
			<!-- Typing Time -->
			<div class="col px-2">
				<div class="card d-flex flex-row gap-2 align-items-center py-2 px-3 h-100">
					<img src="{% static 'img/typing_time.svg' %}" width="50px" height="50px">
					<div class="d-flex flex-column">
						<h6 class="m-0">Typing Time</h6>
						<p class="m-0">{{ request.user.total_time_formatted }}</p>
					</div>
				</div>
			</div>
			
			<!-- Completed Tests -->
			<div class="col px-2">
				<div class="card d-flex flex-row gap-2 align-items-center py-2 px-3 h-100">
					<img src="{% static 'img/test.png' %}" width="50px" height="50px">
					<div class="d-flex flex-column">
						<h6 class="m-0">Completed Tests</h6>
						<p class="m-0">{{ request.user.test_count }}</p>
					</div>
				</div>
			</div>
		</div>

		<!-- Charts -->
		<div class="row m-0 mb-4">
			<div class="col-3 px-2">
				<div class="card pb-2" style="height: 314px !important;">
					<div class="corner-icon d-flex gap-3">
						<i class="bi bi-pie-chart fs-5 pointer" id="mistakes-chart-type"></i>
						<i class="bi bi-gear fs-5 pointer" id="mistakes-chart-settings" tabindex="0" title="Settings" data-bs-toggle="popover" data-bs-trigger="manual" ></i>
						<div id="mistakes-chart-settings-popover" class="d-none">
							<div class="d-flex align-items-center gap-2">
								<label for="mistakes-letter-amount" class="form-label m-0" style="white-space: nowrap;">Amount of letters to show</label>
								<input type="number" id="mistakes-letter-amount" class="form-control form-control-sm" min="3" max="15" value="10">
							</div>
						</div>
					</div>
					<canvas id="mistakes"></canvas>
				</div>
			</div>
			<div class="col-9 px-2">
				<div class="card pt-2 position-relative" style="height: 314px !important;">
					<div class="corner-icon d-flex gap-3">
						<div class="pointer d-flex align-items-center gap-1" id="chart-period-toggle">
							<i class="bi bi-calendar-week fs-5" id="chart-icon"></i><span id="chart-period">Weekly</span>
						</div>
					</div>
					<canvas id="history"></canvas>
				</div>
			</div>
		</div>
	</div>
{% endblock content %}

{% block scripts %}
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        const historyChartData = {{ history_chart_data|default:"null"|safe }};
        const mistakesChartData = {{ mistakes_chart_data|default:"null"|safe }};
    </script>
    <script src="{% static 'js/index.js' %}"></script>
{% endblock scripts %}